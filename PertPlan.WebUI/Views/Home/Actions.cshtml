@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

<svg width="100%" height="400" id="pert-diagram">
    <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L10,5 L0,10 Z" fill="gray" />
        </marker>
    </defs>
</svg>

<script type="module">
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

    const tasks = [
        { id: "A" },
        { id: "B" },
        { id: "C" },
        { id: "D" },
    ];

    const dependencies = [
        { source: "A", target: "B" },
        { source: "A", target: "C" },
        { source: "B", target: "D" },
        { source: "C", target: "D" },
    ];

    const svg = d3.select("#pert-diagram");

    const simulation = d3.forceSimulation()
        .nodes(tasks)
        .force("link", d3.forceLink(dependencies).id((d) => d.id).distance(300))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(400, 200));


    const nodes = svg
        .selectAll("circle")
        .data(tasks)
        .enter()
        .append("circle")
        .attr("r", 20)
        .attr("fill", "lightblue");

    const links = svg
        .selectAll("line")
        .data(dependencies)
        .enter()
        .append("line")
        .attr("stroke", "gray")
        .attr("marker-end", "url(#arrow)");

    const labels = svg
        .selectAll("text")
        .data(tasks)
        .enter()
        .append("text")
        .text((d) => d.id)
        .attr("text-anchor", "middle")
        .attr("dy", "0.3em");

    simulation.on("tick", () => {
        nodes
            .attr("cx", (d) => d.x)
            .attr("cy", (d) => d.y);

        labels
            .attr("x", (d) => d.x)
            .attr("y", (d) => d.y);

        links
            .attr("x1", (d) => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                const sourceRadius = 20; // Radius of the circle
                const x1 = d.source.x + (dx / dr) * sourceRadius;
                return x1;
            })
            .attr("y1", (d) => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                const sourceRadius = 20; // Radius of the circle
                const y1 = d.source.y + (dy / dr) * sourceRadius;
                return y1;
            })
            .attr("x2", (d) => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                const sourceRadius = 20; // Radius of the circle
                const x1 = d.target.x - (dx / dr) * sourceRadius;
                return x1;
            })
            .attr("y2", (d) => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                const sourceRadius = 20; // Radius of the circle
                const y1 = d.target.y - (dy / dr) * sourceRadius;
                return y1;
            })
    });
</script>